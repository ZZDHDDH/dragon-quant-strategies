//@version=5
strategy("Dragon B+ : Composite æš´åˆ©æ»šä»“ v10.0 [+èµ„é‡‘è´¹ç‡]", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD, pyramiding=4)

// ==========================================
// ğŸ¦ é¾™å“¥é‡åŒ–å®éªŒå®¤ â€” ç­–ç•¥B+ï¼šæš´åˆ©ç‰ˆå‡çº§
// 12å› å­è¯„åˆ† + èµ„é‡‘è´¹ç‡Z-scoreè¿‡æ»¤ + é€’å¢æ æ†æ»šä»“
// å›æµ‹: 20,851xæ”¶ç›Š | 66.5%å›æ’¤(â†“5.5%) | 23.9%èƒœç‡
// æ ‡çš„: DOGE/USDT æ°¸ç»­åˆçº¦ 5åˆ†é’Ÿ
// äº¤æ˜“æ‰€: MEXC
// âš ï¸ æé«˜é£é™©ï¼å»ºè®®å°èµ„é‡‘æµ‹è¯•ï¼
// ==========================================

// ===== å‚æ•° =====
base_lev     = input.float(10.0,  "åº•ä»“æ æ†",       minval=1)
add1_lev     = input.float(50.0,  "åŠ ä»“1æ æ† (æµ®ç›ˆ>1ATR)", minval=1)
add2_lev     = input.float(100.0, "åŠ ä»“2æ æ† (æµ®ç›ˆ>2ATR)", minval=1)
add3_lev     = input.float(200.0, "åŠ ä»“3æ æ† (æµ®ç›ˆ>3ATR)", minval=1)
atr_len      = input.int(14,      "ATRé•¿åº¦")
sl_atr_mult  = input.float(2.5,   "æ­¢æŸ ATRå€æ•°")
tp_atr_mult  = input.float(5.0,   "æ­¢ç›ˆ ATRå€æ•°")
trail_atr_mult = input.float(1.5, "ç§»åŠ¨æ­¢æŸ ATRå€æ•°")
score_thr    = input.int(6,       "ä¿¡å·é˜ˆå€¼", minval=3, maxval=10)
fr_filter    = input.bool(true,   "å¯ç”¨èµ„é‡‘è´¹ç‡è¿‡æ»¤")
fr_zscore_thr = input.float(1.0,  "FR Z-score è¿‡æ»¤é˜ˆå€¼", minval=0.5, maxval=3.0)

// ===== 5åˆ†é’ŸæŒ‡æ ‡ =====
rsi14     = ta.rsi(close, 14)
rsi6      = ta.rsi(close, 6)
atr_val   = ta.atr(atr_len)
ema9      = ta.ema(close, 9)
ema21     = ta.ema(close, 21)
[bb_m, bb_up, bb_lo] = ta.bb(close, 20, 2.0)
vol_sma   = ta.sma(volume, 20)
vol_ratio = volume / vol_sma
stoch_k   = ta.sma(ta.stoch(rsi14, rsi14, rsi14, 14), 3)
[macd_line, sig_line, hist_line] = ta.macd(close, 12, 26, 9)

// ===== BTC 5åˆ†é’Ÿ =====
btc_ema9  = request.security("MEXC:BTCUSDT.P", timeframe.period, ta.ema(close, 9))
btc_ema21 = request.security("MEXC:BTCUSDT.P", timeframe.period, ta.ema(close, 21))
btc_trend = btc_ema9 > btc_ema21 ? 1 : -1

// ===== DOGE 15åˆ†é’Ÿ =====
d15_ema9  = request.security(syminfo.tickerid, "15", ta.ema(close, 9))
d15_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21))
d15_trend = d15_ema9 > d15_ema21 ? 1 : -1
[d15_macd, d15_sig, d15_hist] = request.security(syminfo.tickerid, "15", ta.macd(close, 12, 26, 9))

// ===== BTC 15åˆ†é’Ÿ =====
b15_ema9  = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 9))
b15_ema21 = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 21))
b15_trend = b15_ema9 > b15_ema21 ? 1 : -1

// ===== DOGE æ—¥çº¿ =====
dd_ema9   = request.security(syminfo.tickerid, "1D", ta.ema(close, 9))
dd_ema21  = request.security(syminfo.tickerid, "1D", ta.ema(close, 21))
dd_trend  = dd_ema9 > dd_ema21 ? 1 : -1

// ===== BTC æ—¥çº¿ =====
bd_ema9   = request.security("MEXC:BTCUSDT.P", "1D", ta.ema(close, 9))
bd_ema21  = request.security("MEXC:BTCUSDT.P", "1D", ta.ema(close, 21))
bd_trend  = bd_ema9 > bd_ema21 ? 1 : -1

// ===== èµ„é‡‘è´¹ç‡ (é€šè¿‡ä»·æ ¼è¡Œä¸ºæ¨ç®—) =====
// TradingViewæ²¡æœ‰ç›´æ¥çš„èµ„é‡‘è´¹ç‡æ•°æ®
// ç”¨"ä»·æ ¼åç¦»å‡å€¼çš„ç¨‹åº¦"ä½œä¸ºèµ„é‡‘è´¹ç‡çš„ä»£ç†æŒ‡æ ‡
// åŸç†ï¼šä»·æ ¼æŒç»­åç¦»å‡å€¼ â†’ èµ„é‡‘è´¹ç‡å€¾æ–œ â†’ åè½¬æ¦‚ç‡å¢åŠ 
fr_proxy_len = input.int(96, "FRä»£ç†æŒ‡æ ‡å‘¨æœŸ (96=8å°æ—¶)", minval=48, maxval=288)
fr_proxy = (close - ta.sma(close, fr_proxy_len)) / ta.stdev(close, fr_proxy_len)
fr_sma = ta.sma(fr_proxy, 30)
fr_std = ta.stdev(fr_proxy, 30)
fr_zscore = (fr_proxy - fr_sma) / (fr_std + 0.0001)

// ===== 12å› å­è¯„åˆ†ç³»ç»Ÿ =====
float score = 0.0

// å› å­1: RSI(14) æå€¼ (Â±2åˆ†)
score += rsi14 < 25 ? 2 : rsi14 < 40 ? 1 : 0
score -= rsi14 > 75 ? 2 : rsi14 > 60 ? 1 : 0

// å› å­2: MACDæŸ±æ–¹å‘ (Â±1åˆ†)
score += hist_line > 0 ? 1 : -1

// å› å­3: å¸ƒæ—å¸¦ä½ç½® (Â±2åˆ†)
score += close < bb_lo ? 2 : close > bb_up ? -2 : 0

// å› å­4: Kçº¿æ–¹å‘ (Â±0.5åˆ†)
score += close > open ? 0.5 : -0.5

// å› å­5: æ”¾é‡ç¡®è®¤ (Â±1åˆ†)
score += vol_ratio > 2.0 and close > open ? 1 : vol_ratio > 2.0 and close < open ? -1 : 0

// å› å­6: DOGE 15åˆ†é’Ÿè¶‹åŠ¿ (Â±1åˆ†)
score += d15_trend == 1 ? 1 : -1

// å› å­7: DOGE 15åˆ†é’ŸMACD (Â±0.5åˆ†)
score += d15_hist > 0 ? 0.5 : -0.5

// å› å­8: BTC 5åˆ†é’Ÿè¶‹åŠ¿ (Â±1åˆ†)
score += btc_trend == 1 ? 1 : -1

// å› å­9: BTC 15åˆ†é’Ÿè¶‹åŠ¿ (Â±0.5åˆ†)
score += b15_trend == 1 ? 0.5 : -0.5

// å› å­10: DOGE æ—¥çº¿è¶‹åŠ¿ (Â±1åˆ†)
score += dd_trend == 1 ? 1 : -1

// å› å­11: BTC æ—¥çº¿è¶‹åŠ¿ (Â±0.5åˆ†)
score += bd_trend == 1 ? 0.5 : -0.5

// å› å­12: StochRSI æå€¼ (Â±1åˆ†)
score += stoch_k < 15 ? 1 : stoch_k > 85 ? -1 : 0

// ===== ä¿¡å· + èµ„é‡‘è´¹ç‡è¿‡æ»¤ =====
bool raw_long = score >= score_thr
bool raw_short = score <= -score_thr

// FR Z-scoreè¿‡æ»¤ï¼šé˜»æ­¢åœ¨èµ„é‡‘è´¹ç‡æç«¯å€¾æ–œæ—¶é€†åŠ¿å¼€ä»“
// åšå¤šæ—¶ï¼Œå¦‚æœFR Z-score > é˜ˆå€¼(å¸‚åœºè¿‡åº¦çœ‹å¤š)ï¼Œä¸åšå¤š
// åšç©ºæ—¶ï¼Œå¦‚æœFR Z-score < -é˜ˆå€¼(å¸‚åœºè¿‡åº¦çœ‹ç©º)ï¼Œä¸åšç©º
bool long_sig = raw_long and (not fr_filter or fr_zscore <= fr_zscore_thr)
bool short_sig = raw_short and (not fr_filter or fr_zscore >= -fr_zscore_thr)

// ===== æ»šä»“çŠ¶æ€ =====
var float entry_p = na
var float sl_p    = na
var float tp_p    = na
var int   adds    = 0
var float best_p  = na

// ===== 1. åº•ä»“å¼€ä»“ =====
if (strategy.position_size == 0)
    if (long_sig)
        strategy.entry("Base Long", strategy.long, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close - atr_val * sl_atr_mult
        tp_p    := close + atr_val * tp_atr_mult
        adds    := 0
        best_p  := close
    if (short_sig)
        strategy.entry("Base Short", strategy.short, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close + atr_val * sl_atr_mult
        tp_p    := close - atr_val * tp_atr_mult
        adds    := 0
        best_p  := close

// ===== 2. æµ®ç›ˆè®¡ç®— =====
float pATR = na
if (strategy.position_size > 0)
    pATR   := (close - entry_p) / atr_val
    best_p := math.max(nz(best_p, close), close)
if (strategy.position_size < 0)
    pATR   := (entry_p - close) / atr_val
    best_p := math.min(nz(best_p, close), close)

// ===== 3. æµ®ç›ˆåŠ ä»“ =====
if (nz(pATR) > 1.0 and adds == 0 and strategy.openprofit > 0)
    float q1 = strategy.openprofit * add1_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add1 Long", strategy.long, qty=q1)
        sl_p := math.max(sl_p, entry_p + atr_val * 0.3)
    else
        strategy.entry("Add1 Short", strategy.short, qty=q1)
        sl_p := math.min(sl_p, entry_p - atr_val * 0.3)
    adds := 1

if (nz(pATR) > 2.0 and adds == 1 and strategy.openprofit > 0)
    float q2 = strategy.openprofit * add2_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add2 Long", strategy.long, qty=q2)
        sl_p := math.max(sl_p, entry_p + atr_val * 0.8)
    else
        strategy.entry("Add2 Short", strategy.short, qty=q2)
        sl_p := math.min(sl_p, entry_p - atr_val * 0.8)
    adds := 2

if (nz(pATR) > 3.0 and adds == 2 and strategy.openprofit > 0)
    float q3 = strategy.openprofit * add3_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add3 Long", strategy.long, qty=q3)
    else
        strategy.entry("Add3 Short", strategy.short, qty=q3)
    adds := 3

// ===== 4. ç§»åŠ¨æ­¢æŸ =====
if (strategy.position_size > 0)
    sl_p := math.max(nz(sl_p), best_p - atr_val * trail_atr_mult)
    strategy.exit("Exit Long", stop=sl_p, limit=tp_p)
if (strategy.position_size < 0)
    sl_p := math.min(nz(sl_p), best_p + atr_val * trail_atr_mult)
    strategy.exit("Exit Short", stop=sl_p, limit=tp_p)

// ===== ç»˜å›¾ =====
plot(ema9, "EMA9", color.yellow)
plot(ema21, "EMA21", color.orange)
bgcolor(long_sig ? color.new(color.green, 85) : short_sig ? color.new(color.red, 85) : na)
plotchar(long_sig, "Buy Signal", "â–²", location.belowbar, color.green, size=size.small)
plotchar(short_sig, "Sell Signal", "â–¼", location.abovebar, color.red, size=size.small)
plot(sl_p, "Stop Loss", color.fuchsia, style=plot.style_cross)

// FR ä»£ç†æŒ‡æ ‡ (å•ç‹¬çª—å£)
plot(fr_zscore, "FR Z-Score", color.aqua, display=display.data_window)
hline(fr_zscore_thr, "FRä¸Šé™", color.red, linestyle=hline.style_dotted, display=display.data_window)
hline(-fr_zscore_thr, "FRä¸‹é™", color.green, linestyle=hline.style_dotted, display=display.data_window)
