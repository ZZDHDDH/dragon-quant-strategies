//@version=5
strategy("Dragon v14 [ÂÆâÂÖ®Êªö‰ªì]", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD, pyramiding=3, calc_on_every_tick=true, process_orders_on_close=true)

// ==========================================
// ü¶û ÈæôÂì•ÈáèÂåñÂÆûÈ™åÂÆ§ ‚Äî v14 ÂÆâÂÖ®Êªö‰ªìÁâà
// Ê†∏ÂøÉÈÄªËæë: ÊµÆÁõàËææÊ†á ‚Üí Âπ≥‰ªìÈîÅÂà© ‚Üí ‰∏ã‰∏ÄÊ†πKÁ∫øÈáçÂºÄÊõ¥Â§ß‰ªì‰Ωç
// Êù†ÊùÜÈÄíÂ¢û: 10x ‚Üí 20x ‚Üí 30x (ÂÆâÂÖ®‰∏äÈôê)
// ‚òÖ‚òÖ‚òÖ Âú® 1 ÂàÜÈíüÂõæ‰∏äËøêË°å ‚òÖ‚òÖ‚òÖ
// ==========================================

// ===== ÂèØË∞ÉÂèÇÊï∞ =====
lev1           = input.float(10.0,  "Á¨¨1ÊÆµÊù†ÊùÜ (Â∫ï‰ªì)", minval=1, maxval=50)
lev2           = input.float(20.0,  "Á¨¨2ÊÆµÊù†ÊùÜ (Êªö‰ªì1)", minval=1, maxval=100)
lev3           = input.float(30.0,  "Á¨¨3ÊÆµÊù†ÊùÜ (Êªö‰ªì2)", minval=1, maxval=150)
equity_pct     = input.float(50.0,  "ÊØèÊ¨°ÊäïÂÖ•ËµÑÈáëÊØî‰æã%", minval=10, maxval=100)
sl_atr_mult    = input.float(2.5,   "ÂàùÂßãÊ≠¢Êçü ATRÂÄçÊï∞")
trail_atr_mult = input.float(2.0,   "ÁßªÂä®Ê≠¢Êçü ATRÂÄçÊï∞")
roll_thr1      = input.float(1.0,   "Êªö‰ªì1Ëß¶Âèë (ÊµÆÁõàATRÂÄçÊï∞)", minval=0.3)
roll_thr2      = input.float(2.0,   "Êªö‰ªì2Ëß¶Âèë (ÊµÆÁõàATRÂÄçÊï∞)", minval=0.5)
score_thr      = input.int(5,       "‰ø°Âè∑ÈòàÂÄº", minval=3, maxval=10)
max_hold_min   = input.int(120,     "ÊúÄÂ§ßÊåÅ‰ªìÊó∂Èó¥(ÂàÜÈíü)", minval=10)
fr_filter      = input.bool(true,   "ÂêØÁî®FRËøáÊª§")
fr_zscore_thr  = input.float(1.5,   "FR Z-score ÈòàÂÄº")

// ===== 5ÂàÜÈíüÊåáÊ†á =====
rsi14_5m   = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
ema9_5m    = request.security(syminfo.tickerid, "5", ta.ema(close, 9))
ema21_5m   = request.security(syminfo.tickerid, "5", ta.ema(close, 21))
[bbm5, bbu5, bbl5] = request.security(syminfo.tickerid, "5", ta.bb(close, 20, 2.0))
vol5       = request.security(syminfo.tickerid, "5", volume)
vol_sma5   = request.security(syminfo.tickerid, "5", ta.sma(volume, 20))
vol_ratio5 = nz(vol5 / vol_sma5)
[m5, s5, h5] = request.security(syminfo.tickerid, "5", ta.macd(close, 12, 26, 9))
open5      = request.security(syminfo.tickerid, "5", open)
close5     = request.security(syminfo.tickerid, "5", close)
body5      = close5 - open5
atr_5m     = request.security(syminfo.tickerid, "5", ta.atr(14))

stk5_rsi = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
stk5_min = request.security(syminfo.tickerid, "5", ta.lowest(ta.rsi(close, 14), 14))
stk5_max = request.security(syminfo.tickerid, "5", ta.highest(ta.rsi(close, 14), 14))
stochK5  = ta.sma((stk5_rsi - stk5_min) / (stk5_max - stk5_min + 0.0001), 3) * 100

mom5      = request.security(syminfo.tickerid, "5", close - close[10])
obv5_fast = request.security(syminfo.tickerid, "5", ta.ema(ta.obv, 9))
obv5_slow = request.security(syminfo.tickerid, "5", ta.ema(ta.obv, 21))
obv_trend = obv5_fast > obv5_slow ? 1 : -1
kc_mid    = request.security(syminfo.tickerid, "5", ta.ema(close, 20))
kc_atr    = request.security(syminfo.tickerid, "5", ta.atr(14))
kc_up = kc_mid + 1.5 * kc_atr
kc_lo = kc_mid - 1.5 * kc_atr

// 15ÂàÜÈíü
d15_ema9  = request.security(syminfo.tickerid, "15", ta.ema(close, 9))
d15_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21))
d15_trend = d15_ema9 > d15_ema21 ? 1 : -1
[d15m, d15s, d15h] = request.security(syminfo.tickerid, "15", ta.macd(close, 12, 26, 9))

// BTCËÅîÂä®
btc5_ema9  = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 9))
btc5_ema21 = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 21))
btc5_trend = btc5_ema9 > btc5_ema21 ? 1 : -1
b15_ema9   = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 9))
b15_ema21  = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 21))
b15_trend  = b15_ema9 > b15_ema21 ? 1 : -1

// FR‰ª£ÁêÜ
fr_proxy  = (close5 - ta.sma(close5, 96)) / (ta.stdev(close5, 96) + 0.0001)
fr_zscore = (fr_proxy - ta.sma(fr_proxy, 30)) / (ta.stdev(fr_proxy, 30) + 0.0001)

// ===== 13Âõ†Â≠êËØÑÂàÜ =====
float score = 0.0
score += rsi14_5m < 25 ? 2 : rsi14_5m < 40 ? 1 : 0
score -= rsi14_5m > 75 ? 2 : rsi14_5m > 60 ? 1 : 0
score += h5 > 0 ? 1 : -1
score += close5 < bbl5 ? 2 : close5 > bbu5 ? -2 : 0
score += vol_ratio5 > 2.0 and body5 > 0 ? 1 : vol_ratio5 > 2.0 and body5 < 0 ? -1 : 0
score += btc5_trend == 1 ? 1 : -1
score += stochK5 < 15 ? 1 : stochK5 > 85 ? -1 : 0
score += d15_trend == 1 ? 1 : -1
score += d15h > 0 ? 0.5 : -0.5
score += b15_trend == 1 ? 0.5 : -0.5
score += mom5 > 0 ? 0.5 : -0.5
score += obv_trend == 1 ? 0.5 : -0.5
score += close5 < kc_lo ? 1 : close5 > kc_up ? -1 : 0
score += body5 > 0 ? 0.5 : -0.5

// ===== ‰ø°Âè∑ =====
bool long_sig  = score >= score_thr and (not fr_filter or fr_zscore <= fr_zscore_thr)
bool short_sig = score <= -score_thr and (not fr_filter or fr_zscore >= -fr_zscore_thr)
bool is_5m_bar = minute % 5 == 0

// ===== Êªö‰ªìÁä∂ÊÄÅÊú∫ =====
var int   direction   = 0      // 1=Â§ö, -1=Á©∫, 0=Êó†
var float orig_entry  = na     // ÂàùÂßãÂÖ•Âú∫‰ª∑ (‰∏çÂèò,Áî®‰∫éËÆ°ÁÆóATRÊµÆÁõà)
var float sl_p        = na     // ÂΩìÂâçÊ≠¢Êçü
var float best_p      = na     // ÊúÄÈ´ò/ÊúÄ‰Ωé‰ª∑ (ÁßªÂä®Ê≠¢ÊçüÁî®)
var int   roll_stage  = 0      // 0=Â∫ï‰ªì, 1=Â∑≤Êªö1Ê¨°, 2=Â∑≤Êªö2Ê¨°
var int   entry_bar   = 0      // ÂÖ•Âú∫KÁ∫ø
var float cur_atr     = na     // ÂÖ•Âú∫Êó∂ATR
var bool  pending_roll = false // Ê†áËÆ∞: Â∑≤Âπ≥‰ªìÁ≠âÂæÖÈáçÂºÄ
var int   pending_dir  = 0     // ÈáçÂºÄÊñπÂêë
var float pending_lev  = 0.0   // ÈáçÂºÄÊù†ÊùÜ

// ===== 1. Â§ÑÁêÜÂæÖÈáçÂºÄ (‰∏ä‰∏ÄÊ†πKÁ∫øÂπ≥‰ªì, ËøôÊ†πÈáçÂºÄ) =====
if pending_roll and strategy.position_size == 0
    float qty = strategy.equity * (equity_pct / 100) * pending_lev / close
    if pending_dir == 1
        strategy.entry("Roll L", strategy.long, qty=qty)
    else
        strategy.entry("Roll S", strategy.short, qty=qty)
    // Êõ¥Êñ∞Ê≠¢Êçü: ‰øùÊú¨‰øùÊä§
    if pending_dir == 1
        sl_p := math.max(nz(orig_entry, close), close - cur_atr * trail_atr_mult)
        best_p := close
    else
        sl_p := math.min(nz(orig_entry, close), close + cur_atr * trail_atr_mult)
        best_p := close
    pending_roll := false

// ===== 2. Êñ∞‰ø°Âè∑ÂÖ•Âú∫ (Êó†ÊåÅ‰ªì, 5ÂàÜÈíüËæπÁïå) =====
if strategy.position_size == 0 and direction == 0 and not pending_roll
    if long_sig and is_5m_bar
        float qty = strategy.equity * (equity_pct / 100) * lev1 / close
        strategy.entry("Base L", strategy.long, qty=qty)
        direction  := 1
        orig_entry := close
        sl_p       := close - atr_5m * sl_atr_mult
        best_p     := close
        roll_stage := 0
        entry_bar  := bar_index
        cur_atr    := atr_5m
    else if short_sig and is_5m_bar
        float qty = strategy.equity * (equity_pct / 100) * lev1 / close
        strategy.entry("Base S", strategy.short, qty=qty)
        direction  := -1
        orig_entry := close
        sl_p       := close + atr_5m * sl_atr_mult
        best_p     := close
        roll_stage := 0
        entry_bar  := bar_index
        cur_atr    := atr_5m

// ===== 3. ÊåÅ‰ªì‰∏≠: Ê£ÄÊµãÊªö‰ªìÊù°‰ª∂ =====
if strategy.position_size != 0 and not na(cur_atr) and cur_atr > 0 and not pending_roll
    float profit_atr = direction == 1 ? (close - orig_entry) / cur_atr : (orig_entry - close) / cur_atr

    // Êªö‰ªì1: ÊµÆÁõàË∂ÖËøáÈòàÂÄº1, ÂΩìÂâçÂú®Â∫ï‰ªìÈò∂ÊÆµ
    if profit_atr >= roll_thr1 and roll_stage == 0
        strategy.close_all("Roll1 ÈîÅÂà©")
        pending_roll := true
        pending_dir  := direction
        pending_lev  := lev2
        roll_stage   := 1

    // Êªö‰ªì2: ÊµÆÁõàË∂ÖËøáÈòàÂÄº2, ÂΩìÂâçÂú®Êªö‰ªì1Èò∂ÊÆµ
    else if profit_atr >= roll_thr2 and roll_stage == 1
        strategy.close_all("Roll2 ÈîÅÂà©")
        pending_roll := true
        pending_dir  := direction
        pending_lev  := lev3
        roll_stage   := 2

// ===== 4. ÁßªÂä®Ê≠¢Êçü (ÊØèÊ†π1ÂàÜÈíüKÁ∫øÊõ¥Êñ∞) =====
if strategy.position_size != 0 and not na(cur_atr) and not pending_roll
    float trail = cur_atr * trail_atr_mult
    if direction == 1
        best_p := math.max(nz(best_p, close), close)
        float new_sl = best_p - trail
        if roll_stage > 0  // Êªö‰ªìÂêé‰øùÊú¨‰øùÊä§
            new_sl := math.max(new_sl, nz(orig_entry, 0))
        sl_p := math.max(nz(sl_p, 0), new_sl)
        strategy.exit("XL", stop=sl_p)
    else if direction == -1
        best_p := math.min(nz(best_p, close), close)
        float new_sl = best_p + trail
        if roll_stage > 0
            new_sl := math.min(new_sl, nz(orig_entry, 1e18))
        sl_p := math.min(nz(sl_p, 1e18), new_sl)
        strategy.exit("XS", stop=sl_p)

// ===== 5. Ë∂ÖÊó∂Âπ≥‰ªì =====
if strategy.position_size != 0 and bar_index - entry_bar >= max_hold_min and not pending_roll
    strategy.close_all("Ë∂ÖÊó∂Âπ≥‰ªì")
    direction  := 0
    roll_stage := 0

// ===== 6. Ê£ÄÊµãË¢´Ê≠¢ÊçüÂπ≥‰ªì ‚Üí ÈáçÁΩÆ =====
if strategy.position_size == 0 and direction != 0 and not pending_roll
    direction  := 0
    roll_stage := 0

// ===== ÁªòÂõæ =====
plot(ema9_5m, "EMA9(5m)", color.yellow)
plot(ema21_5m, "EMA21(5m)", color.orange)
bgcolor(long_sig and is_5m_bar ? color.new(color.green, 85) : short_sig and is_5m_bar ? color.new(color.red, 85) : na)
plotchar(long_sig and is_5m_bar and strategy.position_size == 0, "Buy", "‚ñ≤", location.belowbar, color.green, size=size.small)
plotchar(short_sig and is_5m_bar and strategy.position_size == 0, "Sell", "‚ñº", location.abovebar, color.red, size=size.small)
plot(strategy.position_size != 0 ? sl_p : na, "ÁßªÂä®Ê≠¢Êçü", color.fuchsia, style=plot.style_cross)

// Êªö‰ªìÈò∂ÊÆµÊ†áÁ≠æ
var label info_label = na
if barstate.islast and direction != 0
    label.delete(info_label)
    string txt = roll_stage == 0 ? "Â∫ï‰ªì " + str.tostring(lev1, "#.#") + "x" : roll_stage == 1 ? "Êªö‰ªì1 " + str.tostring(lev2, "#.#") + "x" : "Êªö‰ªì2 " + str.tostring(lev3, "#.#") + "x"
    info_label := label.new(bar_index, close, txt, style=label.style_label_left, color=color.blue, textcolor=color.white)
