//@version=5
strategy("Dragon B++ v13 [æ— æ­¢ç›ˆ+å®½ç§»åŠ¨æ­¢æŸ]", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD, pyramiding=4, calc_on_every_tick=true)

// ==========================================
// ğŸ¦ é¾™å“¥é‡åŒ–å®éªŒå®¤ â€” ç­–ç•¥B++ v13 ç»ˆæç‰ˆ
// âš¡ 5åˆ†é’Ÿä¿¡å·å…¥åœº + 1åˆ†é’Ÿç²¾ç¡®å‡ºåœº
// ğŸš« æ— æ­¢ç›ˆ â€” è®©åˆ©æ¶¦å¥”è·‘ï¼
// âœ… å®½ç§»åŠ¨æ­¢æŸ 2.0 ATR â€” å›æ’¤æ›´ä½
// â˜…â˜…â˜… è¯·åœ¨ 1 åˆ†é’Ÿå›¾ä¸Šè¿è¡Œæ­¤ç­–ç•¥ â˜…â˜…â˜…
// å›æµ‹(DOGE): 26.1%èƒœç‡ | 45.0%å›æ’¤
// ==========================================

// ===== å‚æ•° =====
base_lev       = input.float(10.0,  "åº•ä»“æ æ†",       minval=1)
add1_lev       = input.float(50.0,  "åŠ ä»“1æ æ† (æµ®ç›ˆ>1ATR)", minval=1)
add2_lev       = input.float(100.0, "åŠ ä»“2æ æ† (æµ®ç›ˆ>2ATR)", minval=1)
add3_lev       = input.float(200.0, "åŠ ä»“3æ æ† (æµ®ç›ˆ>3ATR)", minval=1)
sl_atr_mult    = input.float(2.5,   "åˆå§‹æ­¢æŸ ATRå€æ•°")
trail_atr_mult = input.float(2.0,   "ç§»åŠ¨æ­¢æŸ ATRå€æ•° (æ ¸å¿ƒå‚æ•°)")
score_thr      = input.int(5,       "ä¿¡å·é˜ˆå€¼", minval=3, maxval=10)
max_hold_min   = input.int(120,     "æœ€å¤§æŒä»“æ—¶é—´(åˆ†é’Ÿ)", minval=10, maxval=480)
fr_filter      = input.bool(true,   "å¯ç”¨èµ„é‡‘è´¹ç‡è¿‡æ»¤")
fr_zscore_thr  = input.float(1.5,   "FR Z-score è¿‡æ»¤é˜ˆå€¼")

// =====================================================
// ===== 5åˆ†é’Ÿçº§åˆ«ä¿¡å· (é€šè¿‡ request.security è·å–) =====
// =====================================================

// DOGE 5åˆ†é’ŸæŒ‡æ ‡
rsi14_5m   = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
ema9_5m    = request.security(syminfo.tickerid, "5", ta.ema(close, 9))
ema21_5m   = request.security(syminfo.tickerid, "5", ta.ema(close, 21))
[bbm5, bbu5, bbl5] = request.security(syminfo.tickerid, "5", ta.bb(close, 20, 2.0))
vol5       = request.security(syminfo.tickerid, "5", volume)
vol_sma5   = request.security(syminfo.tickerid, "5", ta.sma(volume, 20))
vol_ratio5 = nz(vol5 / vol_sma5)
[m5, s5, h5] = request.security(syminfo.tickerid, "5", ta.macd(close, 12, 26, 9))
open5      = request.security(syminfo.tickerid, "5", open)
close5     = request.security(syminfo.tickerid, "5", close)
body5      = close5 - open5

// StochRSI on 5m
stk5_rsi = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
stk5_min = request.security(syminfo.tickerid, "5", ta.lowest(ta.rsi(close, 14), 14))
stk5_max = request.security(syminfo.tickerid, "5", ta.highest(ta.rsi(close, 14), 14))
stochK5  = ta.sma((stk5_rsi - stk5_min) / (stk5_max - stk5_min + 0.0001), 3) * 100

// ATR (5åˆ†é’Ÿçº§åˆ«)
atr_5m = request.security(syminfo.tickerid, "5", ta.atr(14))

// åŠ¨é‡ & OBV (5åˆ†é’Ÿ)
mom5     = request.security(syminfo.tickerid, "5", close - close[10])
obv5_fast = request.security(syminfo.tickerid, "5", ta.ema(ta.obv, 9))
obv5_slow = request.security(syminfo.tickerid, "5", ta.ema(ta.obv, 21))
obv_trend = obv5_fast > obv5_slow ? 1 : -1

// Keltner Channel (5åˆ†é’Ÿ)
kc_mid = request.security(syminfo.tickerid, "5", ta.ema(close, 20))
kc_atr = request.security(syminfo.tickerid, "5", ta.atr(14))
kc_up  = kc_mid + 1.5 * kc_atr
kc_lo  = kc_mid - 1.5 * kc_atr

// ===== 15åˆ†é’Ÿçº§åˆ« =====
d15_ema9  = request.security(syminfo.tickerid, "15", ta.ema(close, 9))
d15_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21))
d15_trend = d15_ema9 > d15_ema21 ? 1 : -1
[d15m, d15s, d15h] = request.security(syminfo.tickerid, "15", ta.macd(close, 12, 26, 9))

// ===== BTC è”åŠ¨ =====
btc5_ema9  = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 9))
btc5_ema21 = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 21))
btc5_trend = btc5_ema9 > btc5_ema21 ? 1 : -1

b15_ema9  = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 9))
b15_ema21 = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 21))
b15_trend = b15_ema9 > b15_ema21 ? 1 : -1

// ===== FR ä»£ç†æŒ‡æ ‡ =====
fr_proxy  = (close5 - ta.sma(close5, 96)) / (ta.stdev(close5, 96) + 0.0001)
fr_zscore = (fr_proxy - ta.sma(fr_proxy, 30)) / (ta.stdev(fr_proxy, 30) + 0.0001)

// ===== å¤šå› å­è¯„åˆ† (13ä¸ªå› å­) =====
float score = 0.0

// 1. RSIæå€¼ (Â±2)
score += rsi14_5m < 25 ? 2 : rsi14_5m < 40 ? 1 : 0
score -= rsi14_5m > 75 ? 2 : rsi14_5m > 60 ? 1 : 0
// 2. MACDæ–¹å‘ (Â±1)
score += h5 > 0 ? 1 : -1
// 3. å¸ƒæ—å¸¦ä½ç½® (Â±2)
score += close5 < bbl5 ? 2 : close5 > bbu5 ? -2 : 0
// 4. æ”¾é‡ç¡®è®¤ (Â±1)
score += vol_ratio5 > 2.0 and body5 > 0 ? 1 : vol_ratio5 > 2.0 and body5 < 0 ? -1 : 0
// 5. BTC 5åˆ†é’Ÿè¶‹åŠ¿ (Â±1)
score += btc5_trend == 1 ? 1 : -1
// 6. StochKæå€¼ (Â±1)
score += stochK5 < 15 ? 1 : stochK5 > 85 ? -1 : 0
// 7. 15åˆ†é’Ÿè¶‹åŠ¿ (Â±1)
score += d15_trend == 1 ? 1 : -1
// 8. 15åˆ†é’ŸMACD (Â±0.5)
score += d15h > 0 ? 0.5 : -0.5
// 9. BTC 15åˆ†é’Ÿè¶‹åŠ¿ (Â±0.5)
score += b15_trend == 1 ? 0.5 : -0.5
// 10. åŠ¨é‡ (Â±0.5)
score += mom5 > 0 ? 0.5 : -0.5
// 11. OBVè¶‹åŠ¿ (Â±0.5)
score += obv_trend == 1 ? 0.5 : -0.5
// 12. Keltneré€šé“ (Â±1)
score += close5 < kc_lo ? 1 : close5 > kc_up ? -1 : 0
// 13. Kçº¿æ–¹å‘ (Â±0.5)
score += body5 > 0 ? 0.5 : -0.5

// ===== ä¿¡å· + FRè¿‡æ»¤ =====
bool raw_long  = score >= score_thr
bool raw_short = score <= -score_thr
bool long_sig  = raw_long  and (not fr_filter or fr_zscore <= fr_zscore_thr)
bool short_sig = raw_short and (not fr_filter or fr_zscore >= -fr_zscore_thr)

// åªåœ¨5åˆ†é’Ÿè¾¹ç•Œå¼€ä»“
bool is_5m_bar   = minute % 5 == 0
bool entry_long  = long_sig and is_5m_bar
bool entry_short = short_sig and is_5m_bar

// ===== æ»šä»“çŠ¶æ€ =====
var float entry_p   = na
var float sl_p      = na
var int   adds      = 0
var float best_p    = na
var int   entry_bar = 0

// ===== 1. åº•ä»“å¼€ä»“ =====
if (strategy.position_size == 0)
    if (entry_long)
        strategy.entry("Base Long", strategy.long, qty=strategy.equity * base_lev / close)
        entry_p   := close
        sl_p      := close - atr_5m * sl_atr_mult
        adds      := 0
        best_p    := close
        entry_bar := bar_index
    if (entry_short)
        strategy.entry("Base Short", strategy.short, qty=strategy.equity * base_lev / close)
        entry_p   := close
        sl_p      := close + atr_5m * sl_atr_mult
        adds      := 0
        best_p    := close
        entry_bar := bar_index

// ===== 2. æµ®ç›ˆè®¡ç®— =====
float pATR = na
if (strategy.position_size > 0)
    pATR   := (close - entry_p) / atr_5m
    best_p := math.max(nz(best_p, close), close)
if (strategy.position_size < 0)
    pATR   := (entry_p - close) / atr_5m
    best_p := math.min(nz(best_p, close), close)

// ===== 3. æµ®ç›ˆåŠ ä»“ =====
if (nz(pATR) > 1.0 and adds == 0 and strategy.openprofit > 0)
    float q1 = strategy.openprofit * add1_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add1 L", strategy.long, qty=q1)
        sl_p := math.max(sl_p, entry_p + atr_5m * 0.3)
    else
        strategy.entry("Add1 S", strategy.short, qty=q1)
        sl_p := math.min(sl_p, entry_p - atr_5m * 0.3)
    adds := 1

if (nz(pATR) > 2.0 and adds == 1 and strategy.openprofit > 0)
    float q2 = strategy.openprofit * add2_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add2 L", strategy.long, qty=q2)
        sl_p := math.max(sl_p, entry_p + atr_5m * 0.8)
    else
        strategy.entry("Add2 S", strategy.short, qty=q2)
        sl_p := math.min(sl_p, entry_p - atr_5m * 0.8)
    adds := 2

if (nz(pATR) > 3.0 and adds == 2 and strategy.openprofit > 0)
    float q3 = strategy.openprofit * add3_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add3 L", strategy.long, qty=q3)
    else
        strategy.entry("Add3 S", strategy.short, qty=q3)
    adds := 3

// ===== 4. ç§»åŠ¨æ­¢æŸ (æ ¸å¿ƒ: å®½2.0 ATR, æ— æ­¢ç›ˆ!) =====
if (strategy.position_size > 0)
    sl_p := math.max(nz(sl_p), best_p - atr_5m * trail_atr_mult)
    strategy.exit("Exit Long", stop=sl_p)
if (strategy.position_size < 0)
    sl_p := math.min(nz(sl_p), best_p + atr_5m * trail_atr_mult)
    strategy.exit("Exit Short", stop=sl_p)

// æœ€å¤§æŒä»“æ—¶é—´é™åˆ¶
if (strategy.position_size != 0 and bar_index - entry_bar >= max_hold_min)
    strategy.close_all("Time Exit")

// ===== ç»˜å›¾ =====
plot(ema9_5m, "EMA9(5m)", color.yellow)
plot(ema21_5m, "EMA21(5m)", color.orange)
bgcolor(entry_long ? color.new(color.green, 85) : entry_short ? color.new(color.red, 85) : na)
plotchar(entry_long, "Buy", "â–²", location.belowbar, color.green, size=size.small)
plotchar(entry_short, "Sell", "â–¼", location.abovebar, color.red, size=size.small)
plot(sl_p, "Trailing SL", color.fuchsia, style=plot.style_cross)
