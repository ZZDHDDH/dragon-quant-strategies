//@version=5
strategy("Dragon B++ : Êö¥Âà©Êªö‰ªì v11.0 [1ÂàÜÈíüÁ≤æÁ°ÆÂá∫Âú∫]", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD, pyramiding=4, calc_on_every_tick=true)

// ==========================================
// ü¶û ÈæôÂì•ÈáèÂåñÂÆûÈ™åÂÆ§ ‚Äî Á≠ñÁï•B++ÔºöÊö¥Âà©ÁâàÁªàÊûÅÁâà
// ‚ö° 5ÂàÜÈíü‰ø°Âè∑ÂÖ•Âú∫ + 1ÂàÜÈíüÁ≤æÁ°ÆÂá∫Âú∫
// 12Âõ†Â≠êËØÑÂàÜ + ËµÑÈáëË¥πÁéáËøáÊª§ + ÈÄíÂ¢ûÊù†ÊùÜÊªö‰ªì
// ‚òÖ‚òÖ‚òÖ ËØ∑Âú® 1 ÂàÜÈíüÂõæ‰∏äËøêË°åÊ≠§Á≠ñÁï• ‚òÖ‚òÖ‚òÖ
// ÂõûÊµã: ËÉúÁéá36.7%(‚Üë15%) | ÂõûÊí§44.2%(‚Üì47%)
// ==========================================

// ===== ÂèÇÊï∞ =====
base_lev     = input.float(10.0,  "Â∫ï‰ªìÊù†ÊùÜ",       minval=1)
add1_lev     = input.float(50.0,  "Âä†‰ªì1Êù†ÊùÜ (ÊµÆÁõà>1ATR)", minval=1)
add2_lev     = input.float(100.0, "Âä†‰ªì2Êù†ÊùÜ (ÊµÆÁõà>2ATR)", minval=1)
add3_lev     = input.float(200.0, "Âä†‰ªì3Êù†ÊùÜ (ÊµÆÁõà>3ATR)", minval=1)
sl_atr_mult  = input.float(2.5,   "Ê≠¢Êçü ATRÂÄçÊï∞")
tp_atr_mult  = input.float(5.0,   "Ê≠¢Áõà ATRÂÄçÊï∞")
trail_atr_mult = input.float(1.5, "ÁßªÂä®Ê≠¢Êçü ATRÂÄçÊï∞")
score_thr    = input.int(6,       "‰ø°Âè∑ÈòàÂÄº", minval=3, maxval=10)
max_hold_min = input.int(60,      "ÊúÄÂ§ßÊåÅ‰ªìÊó∂Èó¥(ÂàÜÈíü)", minval=10, maxval=360)
fr_filter    = input.bool(true,   "ÂêØÁî®ËµÑÈáëË¥πÁéáËøáÊª§")
fr_zscore_thr = input.float(1.0,  "FR Z-score ËøáÊª§ÈòàÂÄº")

// =====================================================
// ===== 5ÂàÜÈíüÁ∫ßÂà´‰ø°Âè∑ (ÈÄöËøá request.security Ëé∑Âèñ) =====
// =====================================================

// DOGE 5ÂàÜÈíüÊåáÊ†á
rsi14_5m   = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
ema9_5m    = request.security(syminfo.tickerid, "5", ta.ema(close, 9))
ema21_5m   = request.security(syminfo.tickerid, "5", ta.ema(close, 21))
[bbm5, bbu5, bbl5] = request.security(syminfo.tickerid, "5", ta.bb(close, 20, 2.0))
vol5       = request.security(syminfo.tickerid, "5", volume)
vol_sma5   = request.security(syminfo.tickerid, "5", ta.sma(volume, 20))
vol_ratio5 = vol5 / vol_sma5
[m5, s5, h5] = request.security(syminfo.tickerid, "5", ta.macd(close, 12, 26, 9))
open5      = request.security(syminfo.tickerid, "5", open)
close5     = request.security(syminfo.tickerid, "5", close)
body5      = close5 - open5
stk5_rsi   = request.security(syminfo.tickerid, "5", ta.rsi(close, 14))
stk5_min   = request.security(syminfo.tickerid, "5", ta.lowest(ta.rsi(close, 14), 14))
stk5_max   = request.security(syminfo.tickerid, "5", ta.highest(ta.rsi(close, 14), 14))
stochK5    = ta.sma((stk5_rsi - stk5_min) / (stk5_max - stk5_min + 0.0001), 3) * 100

// ATR (5ÂàÜÈíüÁ∫ßÂà´ÔºåÁî®‰∫éÊ≠¢ÊçüÊ≠¢ÁõàËÆ°ÁÆó)
atr_5m = request.security(syminfo.tickerid, "5", ta.atr(14))

// DOGE 15ÂàÜÈíü
d15_ema9  = request.security(syminfo.tickerid, "15", ta.ema(close, 9))
d15_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21))
d15_trend = d15_ema9 > d15_ema21 ? 1 : -1
[d15m, d15s, d15h] = request.security(syminfo.tickerid, "15", ta.macd(close, 12, 26, 9))

// BTC 5ÂàÜÈíü
btc5_ema9  = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 9))
btc5_ema21 = request.security("MEXC:BTCUSDT.P", "5", ta.ema(close, 21))
btc5_trend = btc5_ema9 > btc5_ema21 ? 1 : -1

// BTC 15ÂàÜÈíü
b15_ema9  = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 9))
b15_ema21 = request.security("MEXC:BTCUSDT.P", "15", ta.ema(close, 21))
b15_trend = b15_ema9 > b15_ema21 ? 1 : -1

// DOGE Êó•Á∫ø
dd_ema9  = request.security(syminfo.tickerid, "1D", ta.ema(close, 9))
dd_ema21 = request.security(syminfo.tickerid, "1D", ta.ema(close, 21))
dd_trend = dd_ema9 > dd_ema21 ? 1 : -1

// BTC Êó•Á∫ø
bd_ema9  = request.security("MEXC:BTCUSDT.P", "1D", ta.ema(close, 9))
bd_ema21 = request.security("MEXC:BTCUSDT.P", "1D", ta.ema(close, 21))
bd_trend = bd_ema9 > bd_ema21 ? 1 : -1

// ===== FR ‰ª£ÁêÜÊåáÊ†á =====
fr_proxy = (close5 - ta.sma(close5, 96)) / (ta.stdev(close5, 96) + 0.0001)
fr_zscore = (fr_proxy - ta.sma(fr_proxy, 30)) / (ta.stdev(fr_proxy, 30) + 0.0001)

// ===== 12Âõ†Â≠êËØÑÂàÜ =====
float score = 0.0
score += rsi14_5m < 25 ? 2 : rsi14_5m < 40 ? 1 : 0
score -= rsi14_5m > 75 ? 2 : rsi14_5m > 60 ? 1 : 0
score += h5 > 0 ? 1 : -1
score += close5 < bbl5 ? 2 : close5 > bbu5 ? -2 : 0
score += body5 > 0 ? 0.5 : -0.5
score += vol_ratio5 > 2.0 and body5 > 0 ? 1 : vol_ratio5 > 2.0 and body5 < 0 ? -1 : 0
score += d15_trend == 1 ? 1 : -1
score += d15h > 0 ? 0.5 : -0.5
score += btc5_trend == 1 ? 1 : -1
score += b15_trend == 1 ? 0.5 : -0.5
score += dd_trend == 1 ? 1 : -1
score += bd_trend == 1 ? 0.5 : -0.5
score += stochK5 < 15 ? 1 : stochK5 > 85 ? -1 : 0

// ===== ‰ø°Âè∑ + FRËøáÊª§ =====
bool raw_long = score >= score_thr
bool raw_short = score <= -score_thr
bool long_sig = raw_long and (not fr_filter or fr_zscore <= fr_zscore_thr)
bool short_sig = raw_short and (not fr_filter or fr_zscore >= -fr_zscore_thr)

// Âè™Âú®5ÂàÜÈíüËæπÁïåÂºÄ‰ªì (ÈÅøÂÖçÈáçÂ§ç)
bool is_5m_bar = minute % 5 == 0
bool entry_long = long_sig and is_5m_bar
bool entry_short = short_sig and is_5m_bar

// ===== Êªö‰ªìÁä∂ÊÄÅ =====
var float entry_p = na
var float sl_p    = na
var float tp_p    = na
var int   adds    = 0
var float best_p  = na
var int   entry_bar = 0

// ===== 1. Â∫ï‰ªìÂºÄ‰ªì (5ÂàÜÈíüËæπÁïåËß¶Âèë) =====
if (strategy.position_size == 0)
    if (entry_long)
        strategy.entry("Base Long", strategy.long, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close - atr_5m * sl_atr_mult
        tp_p    := close + atr_5m * tp_atr_mult
        adds    := 0
        best_p  := close
        entry_bar := bar_index
    if (entry_short)
        strategy.entry("Base Short", strategy.short, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close + atr_5m * sl_atr_mult
        tp_p    := close - atr_5m * tp_atr_mult
        adds    := 0
        best_p  := close
        entry_bar := bar_index

// ===== 2. ÊµÆÁõàËÆ°ÁÆó (ÊØè1ÂàÜÈíüÊõ¥Êñ∞!) =====
float pATR = na
if (strategy.position_size > 0)
    pATR   := (close - entry_p) / atr_5m
    best_p := math.max(nz(best_p, close), close)
if (strategy.position_size < 0)
    pATR   := (entry_p - close) / atr_5m
    best_p := math.min(nz(best_p, close), close)

// ===== 3. ÊµÆÁõàÂä†‰ªì =====
if (nz(pATR) > 1.0 and adds == 0 and strategy.openprofit > 0)
    float q1 = strategy.openprofit * add1_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add1 L", strategy.long, qty=q1)
        sl_p := math.max(sl_p, entry_p + atr_5m * 0.3)
    else
        strategy.entry("Add1 S", strategy.short, qty=q1)
        sl_p := math.min(sl_p, entry_p - atr_5m * 0.3)
    adds := 1

if (nz(pATR) > 2.0 and adds == 1 and strategy.openprofit > 0)
    float q2 = strategy.openprofit * add2_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add2 L", strategy.long, qty=q2)
        sl_p := math.max(sl_p, entry_p + atr_5m * 0.8)
    else
        strategy.entry("Add2 S", strategy.short, qty=q2)
        sl_p := math.min(sl_p, entry_p - atr_5m * 0.8)
    adds := 2

if (nz(pATR) > 3.0 and adds == 2 and strategy.openprofit > 0)
    float q3 = strategy.openprofit * add3_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add3 L", strategy.long, qty=q3)
    else
        strategy.entry("Add3 S", strategy.short, qty=q3)
    adds := 3

// ===== 4. 1ÂàÜÈíüÁ∫ßÂà´ÁßªÂä®Ê≠¢Êçü (Ê†∏ÂøÉÊîπËøõ!) =====
if (strategy.position_size > 0)
    sl_p := math.max(nz(sl_p), best_p - atr_5m * trail_atr_mult)
    strategy.exit("Exit Long", stop=sl_p, limit=tp_p)
if (strategy.position_size < 0)
    sl_p := math.min(nz(sl_p), best_p + atr_5m * trail_atr_mult)
    strategy.exit("Exit Short", stop=sl_p, limit=tp_p)

// ÊúÄÂ§ßÊåÅ‰ªìÊó∂Èó¥ÈôêÂà∂
if (strategy.position_size != 0 and bar_index - entry_bar >= max_hold_min)
    strategy.close_all("Time Exit")

// ===== ÁªòÂõæ =====
plot(ema9_5m, "EMA9(5m)", color.yellow)
plot(ema21_5m, "EMA21(5m)", color.orange)
bgcolor(entry_long ? color.new(color.green, 85) : entry_short ? color.new(color.red, 85) : na)
plotchar(entry_long, "Buy", "‚ñ≤", location.belowbar, color.green, size=size.small)
plotchar(entry_short, "Sell", "‚ñº", location.abovebar, color.red, size=size.small)
plot(sl_p, "SL", color.fuchsia, style=plot.style_cross)
