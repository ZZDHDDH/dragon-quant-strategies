//@version=5
strategy("Dragon A: MTF_RSI ç¨³å¥æ»šä»“ v9.0", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, currency=currency.USD, pyramiding=4)

// ==========================================
// ğŸ¦ é¾™å“¥é‡åŒ–å®éªŒå®¤ â€” ç­–ç•¥Aï¼šç¨³å¥ç‰ˆ
// å¤šæ—¶é—´æ¡†æ¶RSIæå€¼ + BTCè”åŠ¨ + é€’å¢æ æ†æ»šä»“
// å›æµ‹: 6.44xæ”¶ç›Š | 15.3%å›æ’¤ | 35.7%èƒœç‡
// æ ‡çš„: DOGE/USDT æ°¸ç»­åˆçº¦ 5åˆ†é’Ÿ
// äº¤æ˜“æ‰€: MEXC
// ==========================================

// ===== å‚æ•° =====
base_lev     = input.float(10.0,  "åº•ä»“æ æ†",       minval=1)
add1_lev     = input.float(50.0,  "åŠ ä»“1æ æ† (æµ®ç›ˆ>1ATR)", minval=1)
add2_lev     = input.float(100.0, "åŠ ä»“2æ æ† (æµ®ç›ˆ>2ATR)", minval=1)
add3_lev     = input.float(200.0, "åŠ ä»“3æ æ† (æµ®ç›ˆ>3ATR)", minval=1)
atr_len      = input.int(14,      "ATRé•¿åº¦")
sl_atr_mult  = input.float(1.5,   "æ­¢æŸ ATRå€æ•°")
tp_atr_mult  = input.float(3.0,   "æ­¢ç›ˆ ATRå€æ•°")
trail_atr_mult = input.float(1.2, "ç§»åŠ¨æ­¢æŸ ATRå€æ•°")
rsi_os       = input.int(25,      "RSI(14) è¶…å–é˜ˆå€¼", maxval=40)
rsi_ob       = input.int(75,      "RSI(14) è¶…ä¹°é˜ˆå€¼", minval=60)
rsi6_os      = input.int(20,      "RSI(6) è¶…å–é˜ˆå€¼",  maxval=30)
rsi6_ob      = input.int(80,      "RSI(6) è¶…ä¹°é˜ˆå€¼",  minval=70)
vol_thresh   = input.float(1.3,   "æˆäº¤é‡å€æ•°é˜ˆå€¼",   minval=1.0)

// ===== æŒ‡æ ‡ =====
rsi14     = ta.rsi(close, 14)
rsi6      = ta.rsi(close, 6)
atr_val   = ta.atr(atr_len)
ema9      = ta.ema(close, 9)
ema21     = ta.ema(close, 21)
vol_sma   = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

// BTC è”åŠ¨ (åŒå‘¨æœŸ)
btc_rsi = request.security("MEXC:BTCUSDT.P", timeframe.period, ta.rsi(close, 14))

// DOGE 15åˆ†é’Ÿ RSI (é«˜æ—¶é—´æ¡†æ¶ç¡®è®¤)
d15_rsi = request.security(syminfo.tickerid, "15", ta.rsi(close, 14))

// ===== å…¥åœºä¿¡å· =====
// åšå¤š: DOGE RSI(14)<25 + RSI(6)<20 + BTC RSI>25(æœªå´©) + æ”¾é‡>1.3x + é˜³çº¿ç¡®è®¤
long_sig = rsi14 < rsi_os and rsi6 < rsi6_os and btc_rsi > 25 and vol_ratio > vol_thresh and close > open

// åšç©º: DOGE RSI(14)>75 + RSI(6)>80 + BTC RSI<75(æœªæš´æ¶¨) + æ”¾é‡>1.3x + é˜´çº¿ç¡®è®¤
short_sig = rsi14 > rsi_ob and rsi6 > rsi6_ob and btc_rsi < 75 and vol_ratio > vol_thresh and close < open

// ===== æ»šä»“çŠ¶æ€å˜é‡ =====
var float entry_p = na
var float sl_p    = na
var float tp_p    = na
var int   adds    = 0
var float best_p  = na

// ===== 1. åº•ä»“å¼€ä»“ (10xæ æ†) =====
if (strategy.position_size == 0)
    if (long_sig)
        strategy.entry("Base Long", strategy.long, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close - atr_val * sl_atr_mult
        tp_p    := close + atr_val * tp_atr_mult
        adds    := 0
        best_p  := close
    if (short_sig)
        strategy.entry("Base Short", strategy.short, qty=strategy.equity * base_lev / close)
        entry_p := close
        sl_p    := close + atr_val * sl_atr_mult
        tp_p    := close - atr_val * tp_atr_mult
        adds    := 0
        best_p  := close

// ===== 2. æµ®ç›ˆè®¡ç®— =====
float pATR = na
if (strategy.position_size > 0)
    pATR   := (close - entry_p) / atr_val
    best_p := math.max(nz(best_p, close), close)
if (strategy.position_size < 0)
    pATR   := (entry_p - close) / atr_val
    best_p := math.min(nz(best_p, close), close)

// ===== 3. æµ®ç›ˆåŠ ä»“ (ç”¨åˆ©æ¶¦é€’å¢æ æ†) =====
// åŠ ä»“1: æµ®ç›ˆ > 1 ATR â†’ 50xæ æ†
if (nz(pATR) > 1.0 and adds == 0 and strategy.openprofit > 0)
    float q1 = strategy.openprofit * add1_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add1 Long", strategy.long, qty=q1)
        sl_p := math.max(sl_p, entry_p + atr_val * 0.3)
    else
        strategy.entry("Add1 Short", strategy.short, qty=q1)
        sl_p := math.min(sl_p, entry_p - atr_val * 0.3)
    adds := 1

// åŠ ä»“2: æµ®ç›ˆ > 2 ATR â†’ 100xæ æ†
if (nz(pATR) > 2.0 and adds == 1 and strategy.openprofit > 0)
    float q2 = strategy.openprofit * add2_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add2 Long", strategy.long, qty=q2)
        sl_p := math.max(sl_p, entry_p + atr_val * 0.8)
    else
        strategy.entry("Add2 Short", strategy.short, qty=q2)
        sl_p := math.min(sl_p, entry_p - atr_val * 0.8)
    adds := 2

// åŠ ä»“3: æµ®ç›ˆ > 3 ATR â†’ 200xæ æ†
if (nz(pATR) > 3.0 and adds == 2 and strategy.openprofit > 0)
    float q3 = strategy.openprofit * add3_lev / close
    if (strategy.position_size > 0)
        strategy.entry("Add3 Long", strategy.long, qty=q3)
    else
        strategy.entry("Add3 Short", strategy.short, qty=q3)
    adds := 3

// ===== 4. ç§»åŠ¨æ­¢æŸ (è¿½è¸ªæœ€ä¼˜ä»·) =====
if (strategy.position_size > 0)
    sl_p := math.max(nz(sl_p), best_p - atr_val * trail_atr_mult)
    strategy.exit("Exit Long", stop=sl_p, limit=tp_p)
if (strategy.position_size < 0)
    sl_p := math.min(nz(sl_p), best_p + atr_val * trail_atr_mult)
    strategy.exit("Exit Short", stop=sl_p, limit=tp_p)

// ===== ç»˜å›¾ =====
plot(ema9, "EMA9", color.yellow)
plot(ema21, "EMA21", color.orange)
plotchar(long_sig, "Buy Signal", "â–²", location.belowbar, color.green, size=size.small)
plotchar(short_sig, "Sell Signal", "â–¼", location.abovebar, color.red, size=size.small)
plot(sl_p, "Stop Loss", color.fuchsia, style=plot.style_cross)
